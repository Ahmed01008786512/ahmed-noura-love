<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ahmed & Noura Chat üí¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  /* üñ§ Dark mode WhatsApp-like design */
  @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap');
  body {
    margin:0;
    font-family:'Roboto', sans-serif;
    height:100vh;
    display:flex;
    flex-direction:column;
    background-color:#121212;
    color:#fff;
  }
  header {
    text-align:center;
    padding:15px;
    font-size:24px;
    font-weight:500;
    background-color:#1f1f1f;
    border-bottom:1px solid #333;
  }
  #messages {
    flex:1;
    overflow-y:auto;
    padding:10px;
    display:flex;
    flex-direction:column;
  }
  .msg {
    padding:10px 14px;
    border-radius:15px;
    margin:5px 0;
    max-width:70%;
    word-wrap:break-word;
    font-size:15px;
    box-shadow:0 1px 3px rgba(0,0,0,0.3);
  }
  .sent { background-color:#25d366; color:#000; align-self:flex-end; }
  .received { background-color:#2a2a2a; color:#fff; align-self:flex-start; }
  .inputBox {
    display:flex;
    padding:10px;
    background-color:#1f1f1f;
    border-top:1px solid #333;
  }
  input, button, #fileInput {
    padding:10px;
    border-radius:20px;
    border:none;
    font-size:14px;
  }
  input { flex:1; margin-right:8px; background:#2a2a2a; color:#fff; }
  button { background:#25d366; color:#000; cursor:pointer; transition:0.2s; }
  button:hover { opacity:0.85; }
  #fileInput { background:#555; color:#fff; margin-right:8px; }
  #recordBtn { background:#128c7e; color:#fff; margin-left:8px; }
</style>
</head>
<body>

<script>
// üåü Password protection prompt
const correctPassword = "ÿ®ÿ≠ÿ®ŸÉ";
const input = prompt("Noura, tell me the password:");
if(input !== correctPassword){
  document.body.innerHTML = "<h1 style='text-align:center; margin-top:50vh;'>Access Denied</h1>";
  throw "Wrong password!";
}
</script>

<header>Ahmed & Noura üí¨</header>

<div id="messages"></div>

<div class="inputBox">
  <input id="messageInput" placeholder="Type a message...">
  <input type="file" id="fileInput">
  <button onclick="sendMessage()">Send</button>
  <button id="recordBtn">üé§ Voice</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDhuXjM-H9bSymsU01sz27_5prXXTX7rYU",
  authDomain: "ahmed-noura-love.firebaseapp.com",
  databaseURL: "https://ahmed-noura-love-default-rtdb.firebaseio.com",
  projectId: "ahmed-noura-love",
  storageBucket: "ahmed-noura-love.firebasestorage.app",
  messagingSenderId: "791080256640",
  appId: "1:791080256640:web:91d6fcb85c2838a9619265"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

const roomId = "ahmed-noura-private";
const messagesRef = ref(db, "rooms/" + roomId);
const messagesDiv = document.getElementById("messages");

// üåü Send message or image
window.sendMessage = async function(){
  const input = document.getElementById("messageInput");
  const fileInput = document.getElementById("fileInput");
  let content = input.value.trim();

  // Send image
  if(fileInput.files.length > 0){
    const file = fileInput.files[0];
    const storageRef = sRef(storage, `rooms/${roomId}/${Date.now()}_${file.name}`);
    await uploadBytes(storageRef, file);
    const url = await getDownloadURL(storageRef);
    content = `<img src="${url}" style="max-width:200px; border-radius:10px;">`;
    fileInput.value = "";
  }

  if(content !== ""){
    // Mark sent messages with "sent"
    push(messagesRef, { text: content, sender: "me" });
    input.value = "";
  }
}

// üåü Listen for messages
onChildAdded(messagesRef, (data)=>{
  const val = data.val();
  const msg = document.createElement("div");
  msg.className = "msg " + (val.sender === "me" ? "sent" : "received");
  msg.innerHTML = val.text;
  messagesDiv.appendChild(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// üåü Voice recording
let mediaRecorder;
let audioChunks = [];
const recordBtn = document.getElementById("recordBtn");

recordBtn.onclick = async function(){
  if(recordBtn.innerText === "üé§ Voice"){
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = async ()=>{
      const audioBlob = new Blob(audioChunks, {type:'audio/webm'});
      const storageRef = sRef(storage, `rooms/${roomId}/${Date.now()}_voice.webm`);
      await uploadBytes(storageRef, audioBlob);
      const url = await getDownloadURL(storageRef);
      push(messagesRef, { text:`<audio controls src="${url}"></audio>`, sender:"me" });
    };
    mediaRecorder.start();
    recordBtn.innerText = "‚èπÔ∏è Stop";
  } else {
    mediaRecorder.stop();
    recordBtn.innerText = "üé§ Voice";
  }
}
</script>

</body>
</html>